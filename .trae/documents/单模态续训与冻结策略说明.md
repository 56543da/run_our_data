# 单模态续训与冻结策略说明（MMCAF-Net）

本文说明在本仓库新增的训练模式参数 `--train_mode` 下，模型在 **multimodal / img\_only / tab\_only** 三种模式中的运作方式，以及 **哪些模块被冻结/训练**。

## 1. 模型由哪些块组成

以 [MMCAF\_Net.py](file:///e:/run_our_data/MMCAF-Net-main/models/MMCAF_Net.py) 为准，核心模块如下：

* `image_encoder`：图像分支编码器（`Img_new`），把 3D CT 输入编码为 24 维特征 `f`

* `kan`：表格分支编码器（`KANLayer`），把临床特征编码为 24 维特征 `query_tab`

* `multiscale_fusion`：多尺度融合模块（`MultiScale_Fusion`），融合 `f` 与 `query_tab` 得到融合特征 `fea`

* `fin_cls`：最终分类头（`Linear(24,1)`），把融合特征映射为二分类 logit（训练时接 BCEWithLogitsLoss）

forward 简化流程（见 [MMCAF\_Net.forward](file:///e:/run_our_data/MMCAF-Net-main/models/MMCAF_Net.py#L72-L108)）：

1. `f = image_encoder(i)`
2. `query_tab = kan(tab)`
3. `fea = multiscale_fusion(f, query_tab)`
4. `pred = fin_cls(fea)`

## 2. 三种训练模式的“mask”行为（模型如何运作）

模型 forward 有一个 `mode` 参数（见 [MMCAF\_Net.forward](file:///e:/run_our_data/MMCAF-Net-main/models/MMCAF_Net.py#L72-L108)）：

* `mode=0`（multimodal）：不做 mask，正常融合图像 + 表格

* `mode=1`（img\_only）：把 `query_tab` 置零（`query_tab = zeros_like(query_tab)`），强制只靠图像分支信息驱动融合与分类

* `mode=2`（tab\_only）：把 `f` 置零（`f = zeros_like(f)`），强制只靠表格分支信息驱动融合与分类

注意：即使在 img\_only/tab\_only 下，`multiscale_fusion` 仍会被调用；只是在输入侧将其中一个模态的特征置零。

## 3. 单模态续训时：冻结/训练哪些模块

冻结策略实现位于 [train1.py:\_configure\_branch\_training](file:///e:/run_our_data/MMCAF-Net-main/train1.py)。

### 3.1 multimodal（`--train_mode=multimodal`）

* 训练：`image_encoder` + `kan` + `multiscale_fusion` + `fin_cls`（全部训练）

* forward：`mode=0`

* 优化器：包含所有可训练参数

### 3.2 img\_only（`--train_mode=img_only`）

你的要求：固定训练 `image_encoder + multiscale_fusion + fin_cls`，冻结表格分支。

* 冻结：`kan`

* 训练：`image_encoder` + `multiscale_fusion` + `fin_cls`

* forward：`mode=1`（表格特征在 forward 内被置零）

* 含义：表格分支不更新；融合模块与分类头会适配“tab 特征恒为 0”的输入分布，从而把性能提升压力放在图像侧表征学习上

### 3.3 tab\_only（`--train_mode=tab_only`）

你的要求：仅冻结 `image_encoder`（其它都训练）。

* 冻结：`image_encoder`

* 训练：`kan` + `multiscale_fusion` + `fin_cls`

* forward：`mode=2`（图像特征在 forward 内被置零）

* 含义：图像分支不更新；融合模块与分类头会适配“img 特征恒为 0”的输入分布

## 4. 续训时 optimizer/scheduler 是否恢复

新增参数：

* `--resume_optimizer=True|False`

含义：从 `--ckpt_path` 恢复时，是否同时恢复优化器与学习率调度器状态（动量、warmup 进度等）。

建议：

* multimodal 续训通常用 `True`（保持训练轨迹连续）

* img\_only/tab\_only 单模态续训通常用 `False`（因为训练参数子集变化，恢复旧动量/调度可能不合适）

## 5. 在 run\_multi\_experiments.ps1 里如何切换三种模式

在 [run\_multi\_experiments.ps1](file:///e:/run_our_data/MMCAF-Net-main/run_multi_experiments.ps1) 的实验配置中，为每个实验加入：

* `train_mode = "multimodal" | "img_only" | "tab_only"`

* `resume_optim = $true | $false`（对应 `--resume_optimizer`）

示例（与脚本中一致）：

```powershell
@{ name = "Exp1_adam_B32"; lr = "5e-5"; opt = "adam"; batch = "32"; epochs = "100"; eval_freq = "5"; resume = $true; bbox = $false; amp = $False; train_mode = "img_only"; resume_optim = $false }
```

然后脚本会把它们透传到训练命令行参数：

* `--train_mode=$($exp.train_mode)`

* `--resume_optimizer=$($exp.resume_optim)`

